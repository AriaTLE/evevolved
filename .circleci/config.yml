version: 2.1

jobs:
  build-and-push-docker-image:
    # Use the Docker executor with a base image that has the Docker CLI installed
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      # Set up a separate, remote Docker environment to build images securely
      - setup_remote_docker:
        # Optional: enable Docker Layer Caching (DLC) on a paid plan for speed
        # docker_layer_caching: true
      - run:
          name: Build and Push Docker image
          command: |
            # Define image name and tag using a built-in environment variable
            IMAGE_NAME="ariatle/evevolved"
            TAG="0.1.$CIRCLE_BUILD_NUM"

            # Log in to Docker Hub using environment variables
            # DOCKERHUB_USERNAME and DOCKERHUB_PASSWORD must be set in CircleCI
            echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
            
            # Pull the existing base image as a cache source (optional)
            docker pull "$IMAGE_NAME:latest" || true

            # Build the new image, using the pulled image as a cache source
            docker build --cache-from "$IMAGE_NAME:latest" -t "$IMAGE_NAME:$TAG" .

            # Tag the image with "latest" as well
            docker tag "$IMAGE_NAME:$TAG" "$IMAGE_NAME:latest"

            # Push both the specific tag and "latest" tag to the registry
            docker push "$IMAGE_NAME:$TAG"
            docker push "$IMAGE_NAME:latest"

workflows:
  version: 2
  build-pipeline:
    jobs:
      - build-and-push-docker-image